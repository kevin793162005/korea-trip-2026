<!DOCTYPE html>
<html lang="zh-TW" class="h-full">
<head>
    <meta charset="UTF-8">
    <!-- é—œéµï¼šviewport è¨­å®šï¼ŒåŠ å…¥ viewport-fit=cover ä»¥é©æ‡‰ç€æµ·è¢å¹• -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>åŒ—åœ‹çŒ›ç”·å“ˆç±³é” 2026</title>
    
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts (Noto Sans TC) -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <!-- iOS PWA è¨­å®š -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="åŒ—åœ‹çŒ›ç”·">
    <meta name="theme-color" content="#FFFFFF">
    
    <!-- PWA Manifest (Data URI å…§åµŒç‰ˆ) -->
    <link rel="manifest" href="data:application/manifest+json;charset=utf-8,%7B%22name%22%3A%22%E5%8C%97%E5%9C%8B%E7%8C%9B%E7%94%B7%E5%93%88%E7%B1%B3%E9%81%94%22%2C%22short_name%22%3A%22%E5%8C%97%E5%9C%8B%E7%8C%9B%E7%94%B7%22%2C%22start_url%22%3A%22.%2Findex.html%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%23F9FAFB%22%2C%22theme_color%22%3A%22%23F9FAFB%22%2C%22icons%22%3A%5B%7B%22src%22%3A%22https%3A%2F%2Fcdn-icons-png.flaticon.com%2F512%2F3063%2F3063822.png%22%2C%22sizes%22%3A%22192x192%22%2C%22type%22%3A%22image%2Fpng%22%7D%5D%7D">

    <style>
        /* å­—é«”è¨­å®š */
        @font-face {
            font-family: 'ChenYuluoyan';
            src: url('ChenYuluoyan-2.0-Thin.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden; /* é˜²æ­¢æ²å‹•å½ˆæ€§æ•ˆæœéœ²å‡ºèƒŒæ™¯ */
            font-family: 'Noto Sans TC', sans-serif;
            -webkit-tap-highlight-color: transparent;
            /* æ·ºè‰²èƒŒæ™¯ #F9FAFB */
            background-color: #F9FAFB; 
            color: #374151; /* é è¨­æ·±ç°å­— */
            -webkit-overflow-scrolling: touch; 
            user-select: none;
            -webkit-user-select: none;
        }
        
        input, textarea { user-select: text; -webkit-user-select: text; }

        /* è‡ªå®šç¾©æ»¾å‹•æ¢ */
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: rgba(0, 0, 0, 0.15); border-radius: 20px; }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* æŸ”å’Œé™°å½± */
        .soft-shadow { box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08); }
        
        /* é¸ä¸­æ…‹ (æ·±è—) */
        .nav-active { color: #1D4ED8; font-weight: bold; }
        .desktop-nav-active { background: #DBEAFE; color: #1E40AF; border-right: 3px solid #1D4ED8; }
        
        .nav-item { transition: all 0.3s ease; }
        ::placeholder { color: #9CA3AF; opacity: 0.8; }

        /* Safe Area Padding */
        .safe-pb { padding-bottom: calc(env(safe-area-inset-bottom) + 10px); } 
        .safe-pt { padding-top: env(safe-area-inset-top); }
        
        /* å®‰è£æç¤ºå‹•ç•« */
        @keyframes slide-up { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .install-prompt { animation: slide-up 0.5s ease-out forwards; }

        @keyframes fade-in-up { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in-up { animation: fade-in-up 0.3s ease-out forwards; }
    </style>
</head>
<body class="bg-[#F9FAFB] text-gray-700 min-h-screen pb-24 lg:pb-0">

<!-- App å®¹å™¨ -->
<div id="app" class="h-full w-full flex flex-col lg:flex-row lg:p-8 lg:gap-8 lg:max-w-7xl lg:mx-auto relative bg-[#F9FAFB]">

    <!-- PWA å®‰è£æç¤º -->
    <div v-if="showInstallPrompt" class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-4 z-[1001] install-prompt lg:hidden safe-pb">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-[#1D4ED8] rounded-xl flex items-center justify-center text-white font-black text-lg shadow-lg">åŒ—</div>
                <div class="text-sm">
                    <p class="font-bold text-gray-900">åŠ å…¥ä¸»ç•«é¢</p>
                    <p class="text-xs text-gray-500">ç²å¾—å…¨è¢å¹• App é«”é©—</p>
                </div>
            </div>
            <button @click="showInstallPrompt = false" class="text-gray-400 hover:text-gray-700 p-2"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="mt-3 text-xs text-gray-600 bg-gray-50 p-2 rounded-lg border border-gray-200 flex items-center gap-2">
            <i class="fa-solid fa-arrow-up-from-bracket"></i> é»æ“Šç€è¦½å™¨åˆ†äº«æŒ‰éˆ•ï¼Œé¸æ“‡ã€ŒåŠ å…¥ä¸»ç•«é¢ã€
        </div>
    </div>

    <!-- é€£ç·šç‹€æ…‹æŒ‡ç¤ºç‡ˆ -->
    <button @click="forceRefreshData" class="fixed bottom-24 right-4 z-[1000] text-[10px] px-3 py-1.5 rounded-full bg-white shadow-lg border border-gray-200 flex items-center gap-2 hover:bg-gray-50 transition-colors lg:bottom-4 cursor-pointer group text-gray-600 safe-pb">
        <div class="w-2 h-2 rounded-full transition-colors" :class="isOnlineMode ? 'bg-emerald-500' : 'bg-red-500'"></div>
        <span class="font-medium">{{ isOnlineMode ? 'ç·šä¸ŠåŒæ­¥' : 'é›¢ç·šæ¨¡å¼' }}</span>
        <i class="fa-solid fa-rotate-right text-gray-400 group-hover:text-gray-600 group-hover:rotate-180 transition-all duration-500" title="å¼·åˆ¶é‡æ–°è¼‰å…¥è³‡æ–™"></i>
    </button>

    <!-- Loading Overlay -->
    <div v-if="isLoading" class="fixed inset-0 bg-[#F9FAFB] z-[9999] flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="w-12 h-12 border-4 border-gray-300 border-t-[#1D4ED8] rounded-full animate-spin mb-4"></div>
        <p class="text-gray-500 text-sm tracking-widest">è³‡æ–™åŒæ­¥ä¸­...</p>
    </div>

    <!-- DESKTOP SIDEBAR -->
    <aside class="hidden lg:flex flex-col w-64 bg-white rounded-3xl soft-shadow p-6 h-full flex-shrink-0 overflow-y-auto custom-scroll border border-gray-100">
        <div class="mb-8 flex items-center gap-3 flex-shrink-0">
            <div class="flex -space-x-3 overflow-hidden py-1 pl-1">
                <div v-for="(member, idx) in members" :key="idx" class="w-10 h-10 rounded-full bg-gray-100 border-2 border-white flex items-center justify-center text-gray-600 shadow-sm overflow-hidden relative z-0" :style="{ zIndex: members.length - idx }">
                    <img v-if="member.avatar" :src="member.avatar" class="w-full h-full object-cover">
                    <span v-else-if="member.name" class="text-xs font-bold">{{ member.name.charAt(0) }}</span>
                    <i v-else class="fa-solid fa-user text-sm"></i>
                </div>
            </div>
            <div>
                <h1 class="text-xl font-bold text-[#1D4ED8] tracking-wide">åŒ—åœ‹çŒ›ç”·å“ˆç±³é”</h1>
                <p class="text-xs text-gray-500">2026 é‡œå±±ãƒ»æ¿Ÿå· 15æ—¥éŠ</p>
            </div>
        </div>

        <nav class="space-y-2 flex-1">
            <button @click="currentTab = 'schedule'" class="w-full text-left px-4 py-3 rounded-xl flex items-center gap-3 transition-colors font-medium text-gray-600 hover:bg-gray-50" :class="{'desktop-nav-active font-bold': currentTab === 'schedule'}"><i class="fa-solid fa-calendar-day w-6 text-center"></i> è¡Œç¨‹è¦åŠƒ</button>
            <button @click="currentTab = 'bookings'" class="w-full text-left px-4 py-3 rounded-xl flex items-center gap-3 transition-colors font-medium text-gray-600 hover:bg-gray-50" :class="{'desktop-nav-active font-bold': currentTab === 'bookings'}"><i class="fa-solid fa-book-bookmark w-6 text-center"></i> æˆ‘çš„é è¨‚</button>
            <button @click="currentTab = 'expense'" class="w-full text-left px-4 py-3 rounded-xl flex items-center gap-3 transition-colors font-medium text-gray-600 hover:bg-gray-50" :class="{'desktop-nav-active font-bold': currentTab === 'expense'}"><i class="fa-solid fa-wallet w-6 text-center"></i> è¨˜å¸³åˆ†å¸³</button>
            <button @click="currentTab = 'journal'" class="w-full text-left px-4 py-3 rounded-xl flex items-center gap-3 transition-colors font-medium text-gray-600 hover:bg-gray-50" :class="{'desktop-nav-active font-bold': currentTab === 'journal'}"><i class="fa-solid fa-pen-nib w-6 text-center"></i> æ—…è¡Œæ—¥èªŒ</button>
            <button @click="currentTab = 'planning'" class="w-full text-left px-4 py-3 rounded-xl flex items-center gap-3 transition-colors font-medium text-gray-600 hover:bg-gray-50" :class="{'desktop-nav-active font-bold': currentTab === 'planning'}"><i class="fa-solid fa-suitcase w-6 text-center"></i> è¡Œå‰æº–å‚™</button>
            <button @click="currentTab = 'members'" class="w-full text-left px-4 py-3 rounded-xl flex items-center gap-3 transition-colors font-medium text-gray-600 hover:bg-gray-50" :class="{'desktop-nav-active font-bold': currentTab === 'members'}"><i class="fa-solid fa-users w-6 text-center"></i> æˆå“¡ç®¡ç†</button>
        </nav>

        <div class="mt-auto pt-4 border-t border-gray-200 flex-shrink-0">
            <div class="text-xs text-gray-500 text-center"><p>PC Mode Enabled</p><p class="mt-1">ç”±007è¨­è¨ˆ</p></div>
        </div>
    </aside>

    <!-- MAIN CONTENT AREA -->
    <main class="flex-1 flex flex-col h-full overflow-hidden lg:bg-transparent lg:max-w-none w-full min-w-0">

        <!-- MOBILE Header (Fixed Top) -->
        <header class="flex-shrink-0 lg:hidden pt-12 pb-2 px-6 bg-white border-b border-gray-200 z-30 relative safe-pt transition-all sticky top-0">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h1 class="text-2xl font-bold text-[#1D4ED8] tracking-wide">åŒ—åœ‹çŒ›ç”·å“ˆç±³é”</h1>
                    <p class="text-xs text-gray-500 mt-1">2026 é‡œå±±ãƒ»æ¿Ÿå· 15æ—¥éŠ</p>
                </div>
                <div class="flex -space-x-2 overflow-hidden py-1 pl-1">
                    <div v-for="(member, idx) in members" :key="idx" class="w-10 h-10 rounded-full bg-gray-100 border-2 border-white flex items-center justify-center text-gray-600 shadow-sm overflow-hidden relative z-0" :style="{ zIndex: members.length - idx }">
                        <img v-if="member.avatar" :src="member.avatar" class="w-full h-full object-cover">
                        <span v-else-if="member.name" class="text-xs font-bold">{{ member.name.charAt(0) }}</span>
                        <i v-else class="fa-solid fa-user text-sm"></i>
                    </div>
                </div>
            </div>

            <!-- Date Scroller -->
            <div v-if="currentTab === 'schedule'" class="flex space-x-3 overflow-x-auto no-scrollbar py-2">
                <div v-for="date in tripDates" :key="date.full" @click="selectDate(date)" class="flex-shrink-0 flex flex-col items-center justify-center w-14 h-16 rounded-2xl transition-all duration-300 snap-center border" 
                     :class="selectedDate.full === date.full ? 'bg-[#1D4ED8] text-white border-[#1D4ED8] shadow-lg scale-105' : 'bg-white border-gray-200 text-gray-500'">
                    <span class="text-[9px] font-bold opacity-80">Day {{ date.dayNum }}</span>
                    <span class="text-lg font-bold leading-none">{{ date.day }}</span>
                    <span class="text-[9px] font-medium">{{ date.weekday }}</span>
                </div>
            </div>
        </header>

        <!-- SCROLLABLE CONTENT AREA -->
        <div class="flex-1 overflow-y-auto custom-scroll px-5 py-4 pb-40 lg:px-0 lg:py-0 lg:pb-0 safe-pb" id="content-area">

            <!-- DESKTOP Date Scroller -->
            <div v-if="currentTab === 'schedule'" class="hidden lg:block bg-white p-6 rounded-3xl soft-shadow mb-6 border border-gray-100">
                <h2 class="text-lg font-bold text-gray-700 mb-4 px-2">é¸æ“‡æ—¥æœŸ</h2>
                <div class="space-y-6">
                    <!-- Busan Row -->
                    <div><div class="flex items-center gap-2 mb-2 px-2"><span class="w-2 h-2 rounded-full bg-[#1D4ED8]"></span><h3 class="text-xs font-bold text-gray-500 uppercase tracking-widest">Busan é‡œå±±</h3></div>
                        <div class="flex space-x-3 overflow-x-auto no-scrollbar pb-2">
                            <div v-for="date in tripDates.filter(d => d.full <= '2026-03-16')" :key="date.full" @click="selectDate(date)" class="flex-shrink-0 flex flex-col items-center justify-center w-16 h-20 rounded-2xl transition-all duration-300 cursor-pointer border hover:bg-gray-50" 
                                 :class="selectedDate.full === date.full ? 'bg-[#1D4ED8] text-white border-[#1D4ED8] shadow-lg ring-2 ring-offset-2 ring-blue-200' : 'bg-white border-gray-200 text-gray-500'"><span class="text-[10px] font-bold opacity-80 mb-1">Day {{ date.dayNum }}</span><span class="text-xl font-bold leading-none">{{ date.day }}</span><span class="text-xs font-medium mt-1">{{ date.weekday }}</span></div>
                        </div>
                    </div>
                    <!-- Jeju Row -->
                    <div><div class="flex items-center gap-2 mb-2 px-2"><span class="w-2 h-2 rounded-full bg-[#EF4444]"></span><h3 class="text-xs font-bold text-gray-500 uppercase tracking-widest">Jeju æ¿Ÿå·</h3></div>
                        <div class="flex space-x-3 overflow-x-auto no-scrollbar pb-2">
                            <div v-for="date in tripDates.filter(d => d.full > '2026-03-16')" :key="date.full" @click="selectDate(date)" class="flex-shrink-0 flex flex-col items-center justify-center w-16 h-20 rounded-2xl transition-all duration-300 cursor-pointer border hover:bg-gray-50" 
                                 :class="selectedDate.full === date.full ? 'bg-[#EF4444] text-white border-[#EF4444] shadow-lg ring-2 ring-offset-2 ring-red-200' : 'bg-white border-gray-200 text-gray-500'"><span class="text-[10px] font-bold opacity-80 mb-1">Day {{ date.dayNum }}</span><span class="text-xl font-bold leading-none">{{ date.day }}</span><span class="text-[9px] font-medium mt-1">{{ date.weekday }}</span></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SCHEDULE TAB CONTENT -->
            <div v-if="currentTab === 'schedule'" class="max-w-3xl mx-auto">
                <!-- Countdown Card -->
                <div class="bg-gradient-to-br from-[#1D4ED8] to-[#1E40AF] p-5 rounded-3xl shadow-lg mb-6 overflow-hidden relative border border-blue-400/50">
                     <div class="absolute -right-6 -top-6 w-32 h-32 bg-white rounded-full opacity-10 blur-xl"></div>
                    <div v-if="tripStatus === 'before'" class="relative z-10 text-white">
                        <div class="flex justify-between items-end mb-3"><span class="font-bold text-sm flex items-center gap-2 opacity-80"><i class="fa-regular fa-clock"></i> è·é›¢å‡ºç™¼</span><span class="text-5xl font-black tracking-tighter drop-shadow-sm">{{ countdownDays }}<span class="text-base ml-1 font-bold opacity-70">å¤©</span></span></div>
                        <div class="h-2.5 w-full bg-white/20 rounded-full overflow-hidden shadow-inner"><div class="h-full bg-white rounded-full transition-all duration-1000" :style="{ width: countdownProgress + '%' }"></div></div>
                        <div class="flex justify-between mt-2 text-[10px] font-bold opacity-70"><span>æº–å‚™ä¸­</span><span>11/14 æ©Ÿç¥¨é–‹è²·</span></div>
                    </div>
                    <div v-else-if="tripStatus === 'during'" class="relative z-10 text-white">
                         <span class="block text-sm mb-1 font-bold opacity-80">æ—…ç¨‹é€²è¡Œä¸­</span>
                         <span class="text-3xl font-black drop-shadow-sm">Day {{ currentDayNum }}</span>
                         <div class="mt-3 h-1.5 w-full bg-white/20 rounded-full overflow-hidden"><div class="h-full bg-white rounded-full" :style="{ width: tripProgress + '%' }"></div></div>
                    </div>
                    <div v-else class="relative z-10 text-center py-2 text-white"><span class="text-2xl font-bold">æ—…ç¨‹åœ“æ»¿çµæŸ ğŸ‰</span></div>
                </div>

                <div class="space-y-5">
                    <div class="flex justify-between items-end"><h2 class="text-lg font-bold text-gray-700">ç•¶æ—¥è¡Œç¨‹</h2><button @click="openModal()" class="text-sm bg-[#1D4ED8] text-white px-4 py-2 rounded-full shadow-lg active:scale-95 transition-transform hover:bg-blue-600 font-bold"><i class="fa-solid fa-plus mr-1"></i> æ–°å¢</button></div>
                    <div v-if="!currentItinerary.length" class="text-center py-10 text-gray-300 bg-white rounded-3xl border border-dashed border-gray-300"><i class="fa-solid fa-coffee text-4xl mb-3"></i><p>é€™å¤©é‚„æ²’æœ‰å®‰æ’è¡Œç¨‹å–”</p></div>
                    <div class="space-y-4 pl-2 relative">
                        <div class="absolute left-[19px] top-4 bottom-4 w-0.5 bg-gray-200 -z-10"></div>
                        <div v-for="(item, index) in currentItinerary" :key="item.id" class="flex gap-4 relative group">
                            <div class="w-10 pt-1 flex flex-col items-center flex-shrink-0 bg-transparent z-10"><span class="text-xs font-bold text-gray-500">{{ item.time }}</span><div class="w-3 h-3 rounded-full border-2 border-[#F9FAFB] shadow-sm mt-1" :class="getCategoryColor(item.type)"></div></div>
                            <div class="flex-1 bg-white p-4 rounded-2xl soft-shadow border border-gray-100 relative overflow-hidden hover:bg-gray-50 transition-colors">
                                <div class="absolute top-3 right-3 flex items-center gap-1 text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded-full"><i :class="getWeather(item.location).icon"></i><span>{{ getWeather(item.location).temp }}</span></div>
                                <div class="pr-8"><h3 class="font-bold text-gray-800 text-lg">{{ item.title }}</h3><div class="flex items-center text-xs text-gray-500 mt-1 gap-2"><span v-if="item.location"><i class="fa-solid fa-location-dot text-[#1D4ED8]"></i> {{ item.location }}</span><span v-if="item.cost" class="text-gray-600">â‚©{{ formatNumber(item.cost) }}</span></div><p v-if="item.note" class="text-sm text-gray-600 mt-3 bg-gray-50 p-3 rounded-xl border border-gray-200 leading-relaxed">{{ item.note }}</p></div>
                                <div class="absolute bottom-3 right-3 flex gap-2"><button @click="editEvent(item)" class="text-gray-400 hover:text-[#1D4ED8] transition-colors p-1"><i class="fa-solid fa-pen"></i></button><button @click="deleteEvent(index)" class="text-gray-400 hover:text-red-500 transition-colors p-1"><i class="fa-solid fa-trash-can"></i></button></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- BOOKINGS TAB -->
             <div v-if="currentTab === 'bookings'" class="space-y-5">
                <div class="bg-gray-100 p-1 rounded-full flex text-sm font-bold text-gray-600 mb-4 border border-gray-200"><button @click="bookingSubTab = 'flight'" class="flex-1 py-2 rounded-full transition-all text-center" :class="bookingSubTab === 'flight' ? 'bg-white shadow text-gray-800' : 'hover:text-gray-800'">èˆªç­</button><button @click="bookingSubTab = 'hotel'" class="flex-1 py-2 rounded-full transition-all text-center" :class="bookingSubTab === 'hotel' ? 'bg-white shadow text-gray-800' : 'hover:text-gray-800'">ä½å®¿</button><button @click="bookingSubTab = 'car'" class="flex-1 py-2 rounded-full transition-all text-center" :class="bookingSubTab === 'car' ? 'bg-white shadow text-gray-800' : 'hover:text-gray-800'">ç§Ÿè»Š</button></div>
                
                <div v-if="bookingSubTab === 'flight'" class="space-y-5 lg:grid lg:grid-cols-2 lg:gap-6 lg:space-y-0"><div v-for="(flight, index) in flightData" :key="flight.code" class="bg-white rounded-3xl soft-shadow overflow-hidden relative hover:-translate-y-1 transition-transform duration-300 group border border-gray-100"><div class="h-2 w-full" :class="flight.color"></div><button @click="initEditFlight(index)" class="absolute top-4 right-4 bg-gray-100 text-gray-400 hover:bg-[#1D4ED8] hover:text-white p-2 rounded-full transition-colors z-10 w-8 h-8 flex items-center justify-center"><i class="fa-solid fa-pen text-xs"></i></button><div class="p-5"><div class="flex justify-between items-center mb-6 pr-8"><span class="bg-gray-100 text-gray-600 px-2 py-1 rounded text-xs font-bold tracking-wider border border-gray-200">{{ flight.airline }}</span><span class="text-gray-500 text-xs font-mono">{{ flight.date }}</span></div><div class="flex justify-between items-center text-center mb-6"><div><div class="text-3xl font-black text-gray-800 tracking-widest">{{ flight.origin }}</div><div class="text-xs text-gray-500 mt-1">{{ flight.originCity }}</div><div class="text-lg font-bold text-gray-700 mt-1 bg-gray-100 px-2 rounded">{{ flight.depTime }}</div></div><div class="flex-1 px-4 flex flex-col items-center"><div class="text-xs text-gray-500 mb-1">{{ flight.duration }}</div><div class="w-full h-px bg-gray-300 relative flex items-center justify-center"><i class="fa-solid fa-plane text-gray-400 absolute bg-white px-2"></i></div><div class="text-xl font-black font-mono text-[#1D4ED8] mt-2 drop-shadow-sm">{{ flight.code }}</div></div><div><div class="text-3xl font-black text-gray-800 tracking-widest">{{ flight.dest }}</div><div class="text-xs text-gray-500 mt-1">{{ flight.destCity }}</div><div class="text-lg font-bold text-gray-700 mt-1 bg-gray-100 px-2 rounded">{{ flight.arrTime }}</div></div></div><div class="flex justify-between text-xs text-gray-600 mb-4 px-2"><span><i class="fa-solid fa-plane-up mr-1"></i> {{ flight.aircraft }}</span><span><i class="fa-solid fa-suitcase mr-1"></i> {{ flight.baggage }}</span></div><div class="bg-gray-50 rounded-xl p-4 text-xs space-y-2 border border-gray-100"><div class="flex justify-between border-b border-gray-200 pb-2 mb-2"><span class="text-gray-500">é‡‘é¡</span><span class="font-bold text-[#1D4ED8] text-sm">{{ flight.price }}</span></div><div class="grid grid-cols-2 gap-y-2 gap-x-4 text-gray-700"><div><span class="text-gray-500 block text-[10px]">è³¼è²·æ—¥æœŸ</span>{{ flight.purchaseDate }}</div><div><span class="text-gray-500 block text-[10px]">è³¼è²·å¹³å°</span><span class="truncate">{{ flight.platform }}</span></div><div><span class="text-gray-500 block text-[10px]">è³¼è²·å½¢å¼</span>{{ flight.type }}</div><div><span class="text-gray-500 block text-[10px]">è¡Œæé¡åº¦</span>{{ flight.baggage }}</div></div><div v-if="flight.note" class="pt-2 mt-2 border-t border-gray-200 text-gray-600 bg-blue-50/50 p-2 rounded -mx-1"><i class="fa-solid fa-circle-info text-blue-400 mr-1"></i> {{ flight.note }}</div></div></div><div class="absolute -left-2 bottom-48 w-4 h-4 rounded-full bg-[#F9FAFB]"></div><div class="absolute -right-2 bottom-48 w-4 h-4 rounded-full bg-[#F9FAFB]"></div></div></div>
                <div v-if="bookingSubTab === 'hotel'" class="space-y-4"><div v-for="(hotel, index) in accommodations" :key="index" class="bg-white rounded-2xl p-4 soft-shadow hover:bg-gray-50 transition-colors relative group border border-gray-100"><div class="flex justify-between items-start mb-2"><span class="text-xs font-bold text-indigo-500 bg-indigo-100 px-2 py-1 rounded-lg">{{ hotel.city }}</span><button @click="editAccommodation(index)" class="text-gray-400 text-xs hover:text-gray-600 p-1"><i class="fa-solid fa-pen"></i></button></div><h4 class="font-bold text-gray-800 text-lg mb-1">{{ hotel.name }}</h4><p class="text-xs text-gray-500 flex items-center gap-1 mb-3"><i class="fa-solid fa-location-dot text-gray-400"></i> {{ hotel.address }}</p><div class="bg-gray-50 rounded-xl p-3 text-xs flex justify-between text-gray-600 border border-gray-100"><div><span class="block text-[10px] text-gray-500 mb-0.5">Check-in</span><span class="font-bold text-gray-800">{{ hotel.checkIn }}</span></div><div class="text-right"><span class="block text-[10px] text-gray-500 mb-0.5">è¨‚å–®ç·¨è™Ÿ</span><span class="font-mono text-gray-800">{{ hotel.ref }}</span></div></div><button @click="deleteAccommodation(index)" class="absolute top-4 right-8 text-red-300/50 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity p-1"><i class="fa-solid fa-trash-can"></i></button></div><button @click="addNewAccommodation" class="w-full py-4 border-2 border-dashed border-gray-300 rounded-2xl text-gray-400 font-bold hover:bg-gray-50 hover:border-[#1D4ED8] hover:text-[#1D4ED8] transition-colors flex items-center justify-center gap-2"><i class="fa-solid fa-plus"></i> æ–°å¢ä½å®¿</button></div>
                <div v-if="bookingSubTab === 'car'" class="space-y-4"><div v-if="!carRental.company && !carRental.carModel" class="bg-white rounded-2xl p-8 text-center soft-shadow border border-gray-100"><div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4 text-gray-500"><i class="fa-solid fa-car text-2xl"></i></div><p class="text-gray-500 text-sm mb-4">å°šæœªè¨­å®šç§Ÿè»Šè³‡è¨Š</p><button @click="editCar" class="bg-[#1D4ED8] text-white px-6 py-2 rounded-xl text-sm font-bold shadow-lg active:scale-95 transition-transform hover:bg-blue-600">å»ºç«‹ç§Ÿè»Šé è¨‚</button></div><div v-else class="bg-white rounded-2xl p-5 soft-shadow relative group border border-gray-100"><div class="flex justify-between items-start mb-4"><div><span class="text-[10px] font-bold text-white bg-[#1D4ED8] px-2 py-1 rounded mb-2 inline-block shadow-sm">{{ carRental.company }}</span><h4 class="font-bold text-gray-800 text-xl">{{ carRental.carModel }}</h4></div><div class="text-right"><button @click="editCar" class="text-gray-400 hover:text-gray-800 p-1"><i class="fa-solid fa-pen"></i></button></div></div><div class="flex gap-4 text-xs text-gray-600 mb-4"><div class="flex-1 bg-gray-50 p-2 rounded-lg border border-gray-200"><span class="block text-[10px] text-gray-500 mb-1">å–è»Š</span><div class="font-bold text-gray-800">{{ carRental.pickupDate }}</div><div class="text-[10px] truncate text-gray-600">{{ carRental.pickupLocation }}</div></div><div class="flex items-center text-gray-500"><i class="fa-solid fa-arrow-right"></i></div><div class="flex-1 bg-gray-50 p-2 rounded-lg border border-gray-200"><span class="block text-[10px] text-gray-500 mb-1">é‚„è»Š</span><div class="font-bold text-gray-800">{{ carRental.returnDate }}</div><div class="text-[10px] truncate text-gray-600">{{ carRental.returnLocation }}</div></div></div><div class="flex justify-between items-center pt-3 border-t border-gray-200 text-xs"><span class="font-mono text-gray-500">Ref: {{ carRental.ref }}</span><span class="font-bold text-[#1D4ED8] text-sm">{{ carRental.price }}</span></div></div></div>
            </div>

            <div v-if="currentTab === 'expense'" class="flex flex-col gap-6 lg:grid lg:grid-cols-12 lg:gap-8 lg:items-start lg:block">
                <div class="contents lg:block lg:col-span-5 lg:sticky lg:top-8 lg:space-y-6">
                    <!-- Stats -->
                    <div class="order-2 bg-gradient-to-br from-[#1D4ED8] to-[#1E40AF] text-white p-6 rounded-3xl shadow-lg relative overflow-hidden lg:mb-6"><div class="absolute -right-6 -top-6 w-32 h-32 bg-white rounded-full opacity-10 blur-2xl"></div><p class="text-white/70 text-sm mb-1 font-bold">{{ expenseFilter === 'all' ? 'ç¸½æ”¯å‡º' : expenseFilter + ' çš„æ”¯å‡º' }} (TWD)</p><h2 class="text-4xl font-black tracking-tight truncate">NT$ {{ formatNumber(totalExpenseTWD) }}</h2><div class="mt-4 flex gap-4 text-xs text-white/80 font-bold"><div><p>éŸ“å…ƒæ”¯å‡º</p><p class="font-mono">â‚© {{ formatNumber(totalExpenseKRW) }}</p></div><div><p>åŒ¯ç‡ (é è¨­)</p><p class="font-mono">1 : {{ exchangeRate }}</p></div></div></div>
                    <!-- Form -->
                    <div class="order-1 bg-white p-5 rounded-3xl soft-shadow border border-gray-100"><h3 class="font-bold text-gray-700 mb-4 flex items-center gap-2"><i class="fa-solid fa-calculator text-[#1D4ED8]"></i> å¿«é€Ÿè¨˜å¸³</h3><div class="grid grid-cols-2 gap-3 mb-3"><div><label class="text-xs text-gray-500 block mb-1">å¤–å¹£é‡‘é¡ (KRW)</label><input type="number" inputmode="numeric" pattern="[0-9]*" v-model.number="newExpense.amount" class="w-full bg-gray-100 text-gray-800 rounded-xl px-3 py-2 text-lg font-bold outline-none focus:ring-2 focus:ring-blue-400" placeholder="0" onkeypress="return event.charCode >= 48 && event.charCode <= 57"></div><div><label class="text-xs text-gray-500 block mb-1">ç´„åˆå°å¹£ (TWD)</label><div class="w-full bg-gray-100 text-gray-500 rounded-xl px-3 py-2 text-lg font-bold border border-gray-200">{{ Math.round(newExpense.amount * exchangeRate) }}</div></div></div><div class="flex gap-2 mb-3"><input type="text" v-model="newExpense.title" class="flex-1 min-w-0 w-full bg-gray-100 text-gray-800 rounded-xl px-3 py-2 outline-none focus:ring-2 focus:ring-blue-400 border border-gray-200" placeholder="æ¶ˆè²»é …ç›®"><button @click="$refs.expenseFile.click()" class="bg-gray-100 text-gray-500 w-12 flex-shrink-0 rounded-xl flex items-center justify-center hover:bg-gray-200 hover:text-[#1D4ED8] transition-colors relative overflow-hidden group border border-gray-200"><img v-if="newExpense.image" :src="newExpense.image" class="w-full h-full object-cover absolute inset-0 opacity-60"><i class="fa-solid fa-camera z-10 group-hover:scale-110 transition-transform" :class="newExpense.image ? 'text-gray-800' : ''"></i></button><input type="file" ref="expenseFile" accept="image/*" class="hidden" @change="handleExpenseImage"></div><div class="flex gap-2 mb-4 overflow-x-auto no-scrollbar pb-2"><button v-for="member in members" :key="member.id || member.name" @click="newExpense.payer = member.name" class="px-3 py-1 rounded-full text-sm border whitespace-nowrap transition-colors flex-shrink-0 flex items-center gap-1" :class="newExpense.payer === member.name ? 'bg-[#1D4ED8] text-white border-[#1D4ED8] font-bold' : 'border-gray-300 text-gray-600'"><div v-if="member.avatar" class="w-4 h-4 rounded-full overflow-hidden border border-white/30"><img :src="member.avatar" class="w-full h-full object-cover"></div>{{ member.name }}</button></div><button @click="addExpense" class="w-full bg-[#1D4ED8] text-white py-3 rounded-xl font-bold shadow-lg active:scale-95 transition-transform hover:bg-blue-600">åŠ å…¥å¸³æœ¬</button></div>
                </div>
                <!-- List -->
                <div class="order-3 lg:col-span-7"><div class="flex justify-between items-end mb-3 ml-1"><h3 class="font-bold text-gray-700">æœ€è¿‘æ¶ˆè²»</h3><div class="flex space-x-2 overflow-x-auto no-scrollbar max-w-[60%] justify-end"><button @click="expenseFilter = 'all'" class="px-2 py-1 rounded-full text-[10px] font-bold whitespace-nowrap transition-colors border" :class="expenseFilter === 'all' ? 'bg-[#1D4ED8] text-white border-[#1D4ED8]' : 'bg-white text-gray-600 border-gray-300'">å…¨é«”</button><button v-for="member in members" :key="member.id || member.name" @click="expenseFilter = member.name" class="px-2 py-1 rounded-full text-[10px] font-bold whitespace-nowrap transition-colors border flex items-center gap-1" :class="expenseFilter === member.name ? 'bg-[#1D4ED8] text-white border-[#1D4ED8]' : 'bg-white text-gray-600 border-gray-300'"><div v-if="member.avatar" class="w-3 h-3 rounded-full overflow-hidden border border-white/50"><img :src="member.avatar" class="w-full h-full object-cover"></div>{{ member.name }}</button></div></div><div class="space-y-3"><div v-for="(exp, idx) in filteredExpenses" :key="idx" class="bg-white p-4 rounded-2xl soft-shadow hover:bg-gray-50 transition-colors relative border border-gray-100"><div class="flex items-center gap-3 flex-1 min-w-0"><div v-if="exp.image" @click="viewImage(exp.image)" class="w-12 h-12 rounded-xl bg-gray-100 overflow-hidden cursor-pointer border border-gray-300 group flex-shrink-0"><img :src="exp.image" class="w-full h-full object-cover group-hover:scale-110 transition-transform"></div><div v-else class="w-12 h-12 rounded-full bg-gray-100 flex items-center justify-center text-[#1D4ED8] flex-shrink-0"><i class="fa-solid fa-receipt"></i></div><div class="min-w-0"><p class="font-bold text-gray-800 truncate">{{ exp.title }}</p><div class="flex items-center gap-1 text-xs text-gray-500 truncate"><div v-if="getMemberAvatar(exp.payer)" class="w-4 h-4 rounded-full overflow-hidden border border-gray-400 flex-shrink-0"><img :src="getMemberAvatar(exp.payer)" class="w-full h-full object-cover"></div><span>{{ exp.payer }} â€¢ {{ exp.date }}</span></div></div></div><div class="text-right flex-shrink-0 ml-3"><p class="font-bold text-gray-800">â‚©{{ formatNumber(exp.amount) }}</p><p class="text-xs text-gray-500">â‰ˆ NT${{ formatNumber(Math.round(exp.amount * exchangeRate)) }}</p></div><button @click="initEditExpense(exp)" class="ml-2 text-gray-400 hover:text-gray-600 p-1"><i class="fa-solid fa-pen"></i></button></div><div v-if="filteredExpenses.length === 0" class="text-center py-8 text-gray-500"><p class="text-xs">æ²’æœ‰ç›¸é—œæ¶ˆè²»ç´€éŒ„</p></div></div></div>
            </div>

            <div v-if="currentTab === 'journal'" class="space-y-8 max-w-3xl mx-auto">
                <div class="flex justify-between items-center px-1"><h2 class="text-xl font-bold text-gray-700">æ—…è¡Œæ—¥èªŒ</h2><button @click="initAddJournal" class="text-sm bg-[#1D4ED8] text-white px-4 py-2 rounded-full shadow-lg active:scale-95 transition-transform hover:bg-blue-600 font-bold"><i class="fa-solid fa-pen-nib mr-1"></i> å¯«æ—¥èªŒ</button></div>
                <div v-if="journals.length === 0" class="text-center py-20 text-gray-500 bg-white rounded-3xl border border-dashed border-gray-300"><i class="fa-solid fa-feather text-4xl mb-3"></i><p>é‚„æ²’æœ‰å¯«ä¸‹ä»»ä½•å›æ†¶...</p></div>
                
                <!-- Group Journals by Date -->
                <template v-for="(group, date) in groupedJournals" :key="date">
                    <div class="relative pl-4 border-l-2 border-gray-200 space-y-6">
                         <div class="absolute -left-[9px] top-0 w-4 h-4 rounded-full bg-[#1D4ED8] border-4 border-[#F9FAFB]"></div>
                         <div class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-2 pl-1">{{ date }}</div>
                         
                         <div v-for="(journal, idx) in group" :key="journal.id" class="bg-white p-4 rounded-2xl soft-shadow border border-gray-100 relative group">
                            <div class="flex justify-between items-start mb-3">
                                <div class="flex items-center gap-2">
                                     <div class="w-8 h-8 rounded-full bg-gray-100 overflow-hidden border border-gray-200"><img v-if="getMemberAvatar(journal.author)" :src="getMemberAvatar(journal.author)" class="w-full h-full object-cover"><div v-else class="w-full h-full flex items-center justify-center text-gray-400 text-xs"><i class="fa-solid fa-user"></i></div></div>
                                     <span class="text-sm font-bold text-gray-800">{{ journal.author }}</span>
                                </div>
                                <div class="flex gap-2">
                                    <button @click="editJournal(journal)" class="text-gray-300 hover:text-gray-600 p-1 transition-colors"><i class="fa-solid fa-pen"></i></button>
                                    <button @click="deleteJournal(journal)" class="text-gray-300 hover:text-red-500 p-1 transition-colors"><i class="fa-solid fa-trash-can"></i></button>
                                </div>
                            </div>
                            
                            <p class="text-gray-600 text-sm leading-relaxed whitespace-pre-line mb-3">{{ journal.content }}</p>
                            
                            <!-- Thumbnail Grid (Click to Zoom) -->
                            <div v-if="journal.photos && journal.photos.length" class="flex gap-2 overflow-x-auto pb-1 no-scrollbar">
                                <div v-for="(photo, pIdx) in journal.photos" :key="pIdx" class="w-20 h-20 rounded-xl overflow-hidden flex-shrink-0 cursor-pointer border border-gray-100 bg-gray-50" @click="viewImage(photo)">
                                    <img :src="photo" class="w-full h-full object-cover hover:scale-110 transition-transform duration-300">
                                </div>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
            
            <div v-if="currentTab === 'planning'" class="space-y-6 lg:space-y-0 lg:grid lg:grid-cols-2 lg:gap-8 lg:items-start"><div class="space-y-6"><div class="bg-gray-100 rounded-3xl p-5 text-center text-gray-500 border border-gray-200"><i class="fa-solid fa-pen-nib text-3xl mb-2"></i><p class="text-sm">æ—…è¡Œæ—¥èªŒå·²ç§»å‹•è‡³ç¨ç«‹åˆ†é </p></div></div><div class="bg-white rounded-3xl soft-shadow p-5 h-full border border-gray-100"><div class="flex gap-4 border-b border-gray-200 pb-2 mb-4"><button @click="currentList = 'todo'" class="pb-1 text-sm font-bold transition-colors" :class="currentList === 'todo' ? 'text-[#1D4ED8] border-b-2 border-[#1D4ED8]' : 'text-gray-500 hover:text-gray-700'">å¾…è¾¦</button><button @click="currentList = 'packing'" class="pb-1 text-sm font-bold transition-colors" :class="currentList === 'packing' ? 'text-[#1D4ED8] border-b-2 border-[#1D4ED8]' : 'text-gray-500 hover:text-gray-700'">è¡Œæ</button><button @click="currentList = 'wish'" class="pb-1 text-sm font-bold transition-colors" :class="currentList === 'wish' ? 'text-[#1D4ED8] border-b-2 border-[#1D4ED8]' : 'text-gray-500 hover:text-gray-700'">æƒ³å»</button></div><div class="space-y-2"><div v-for="(item, idx) in getCurrentListItems" :key="idx" class="flex items-center gap-3 p-2 hover:bg-gray-50 rounded-lg cursor-pointer group" @click="toggleListItem(idx)"><div class="w-5 h-5 rounded border-2 flex items-center justify-center transition-colors flex-shrink-0" :class="item.done ? 'bg-emerald-500 border-emerald-500 text-white' : 'border-gray-400 text-transparent'"><i class="fa-solid fa-check text-xs"></i></div><div class="flex-1 min-w-0"><span :class="item.done ? 'text-gray-400 line-through' : 'text-gray-700'" class="block truncate">{{ item.text }}</span><div v-if="item.assignee && item.assignee !== 'å…¨é«”'" class="flex items-center gap-1 mt-1"><div v-if="getMemberAvatar(item.assignee)" class="w-3 h-3 rounded-full overflow-hidden border border-gray-400"><img :src="getMemberAvatar(item.assignee)" class="w-full h-full object-cover"></div><span class="text-[10px] bg-gray-100 text-gray-600 px-1.5 py-0.5 rounded">{{ item.assignee }}</span></div></div><button @click.stop="deleteListItem(idx)" class="opacity-0 group-hover:opacity-100 text-gray-400 hover:text-red-500 transition-opacity"><i class="fa-solid fa-xmark"></i></button></div></div><div class="mt-4 flex gap-2"><select v-model="newItemAssignee" class="bg-gray-100 text-gray-700 rounded-lg px-2 text-xs outline-none w-16 appearance-none border border-gray-300"><option value="å…¨é«”">å…¨é«”</option><option v-for="m in members" :key="m.id || m.name" :value="m.name">{{ m.name }}</option></select><input type="text" v-model="newItemInput" @keyup.enter="addListItem" placeholder="æ–°å¢é …ç›®..." class="flex-1 bg-gray-100 text-gray-800 rounded-lg px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-blue-400 border border-gray-300"><button @click="addListItem" class="text-[#1D4ED8] font-bold px-2 hover:text-blue-600"><i class="fa-solid fa-plus"></i></button></div></div></div>
            <div v-if="currentTab === 'members'" class="space-y-6"><div class="flex justify-between items-center px-1"><h2 class="text-xl font-bold text-gray-700">æˆå“¡ç®¡ç†</h2><button @click="initAddMember" class="text-sm bg-[#1D4ED8] text-white px-4 py-2 rounded-full shadow-lg active:scale-95 transition-transform hover:bg-blue-600 font-bold"><i class="fa-solid fa-plus mr-1"></i> æ–°å¢</button></div><div class="bg-white p-6 rounded-3xl soft-shadow min-h-[50vh] border border-gray-100"><div class="grid grid-cols-2 gap-4 sm:grid-cols-3 md:grid-cols-4"><div v-for="(member, idx) in members" :key="member.id || idx" @click="editMember(member, idx)" class="bg-gray-100 p-4 rounded-2xl flex flex-col items-center justify-center relative group hover:bg-gray-200 transition-colors border border-gray-200 cursor-pointer shadow-sm hover:shadow-md aspect-[4/5]"><div class="w-20 h-20 rounded-full bg-white mb-3 flex items-center justify-center text-gray-500 shadow-inner border border-gray-300 overflow-hidden relative"><img v-if="member.avatar" :src="member.avatar" class="w-full h-full object-cover"><span v-else-if="member.name" class="text-2xl font-bold text-gray-500">{{ member.name.charAt(0) }}</span><i v-else class="fa-solid fa-user text-3xl"></i><div class="absolute inset-0 bg-black/10 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity"><i class="fa-solid fa-pen text-white"></i></div></div><span class="font-bold text-gray-700 text-lg truncate w-full text-center">{{ member.name }}</span><span class="text-[10px] text-gray-500 mt-1">é»æ“Šç·¨è¼¯</span><button v-if="members.length > 1" @click.stop="initDeleteMember(idx)" class="absolute top-2 right-2 text-gray-400 hover:text-red-500 p-1.5 z-10 transition-colors"><i class="fa-solid fa-xmark"></i></button></div></div><div class="mt-8 p-4 bg-blue-50/50 rounded-xl text-xs text-blue-600 leading-relaxed border border-blue-200"><p class="font-bold mb-1 text-[#1D4ED8]"><i class="fa-solid fa-circle-exclamation mr-1"></i> æ³¨æ„äº‹é …</p><ul class="list-disc list-inside space-y-1 ml-1 opacity-90"><li>æ–°å¢æˆå“¡éœ€è¼¸å…¥ç®¡ç†å¯†ç¢¼ã€‚</li><li>åˆªé™¤æˆå“¡éœ€è¼¸å…¥ç®¡ç†å¯†ç¢¼ã€‚</li><li>é»æ“Šå¡ç‰‡å¯è‡ªç”±ä¿®æ”¹å¤§é ­è²¼èˆ‡åç¨± (æœ€å¤š3å­—)ã€‚</li></ul></div></div></div>
        </div>

    </main>

    <!-- MOBILE Bottom Navigation -->
    <nav class="lg:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 grid grid-cols-6 gap-0 items-center z-[999] h-20 pb-2 safe-pb">
        <button @click="currentTab = 'schedule'" class="nav-item flex flex-col items-center justify-center h-full gap-1 text-gray-400 hover:text-[#1D4ED8]" :class="{'nav-active': currentTab === 'schedule'}"><i class="fa-solid fa-calendar-day text-xl"></i><span class="text-xs font-medium">è¡Œç¨‹</span></button>
        <button @click="currentTab = 'bookings'" class="nav-item flex flex-col items-center justify-center h-full gap-1 text-gray-400 hover:text-[#1D4ED8]" :class="{'nav-active': currentTab === 'bookings'}"><i class="fa-solid fa-book-bookmark text-xl"></i><span class="text-xs font-medium">é è¨‚</span></button>
        <button @click="currentTab = 'expense'" class="nav-item flex flex-col items-center justify-center h-full gap-1 text-gray-400 hover:text-[#1D4ED8]" :class="{'nav-active': currentTab === 'expense'}"><i class="fa-solid fa-wallet text-xl"></i><span class="text-xs font-medium">è¨˜å¸³</span></button>
        <button @click="currentTab = 'journal'" class="nav-item flex flex-col items-center justify-center h-full gap-1 text-gray-400 hover:text-[#1D4ED8]" :class="{'nav-active': currentTab === 'journal'}"><i class="fa-solid fa-pen-nib text-xl"></i><span class="text-xs font-medium">æ—¥èªŒ</span></button>
        <button @click="currentTab = 'planning'" class="nav-item flex flex-col items-center justify-center h-full gap-1 text-gray-400 hover:text-[#1D4ED8]" :class="{'nav-active': currentTab === 'planning'}"><i class="fa-solid fa-suitcase text-xl"></i><span class="text-xs font-medium">æº–å‚™</span></button>
        <button @click="currentTab = 'members'" class="nav-item flex flex-col items-center justify-center h-full gap-1 text-gray-400 hover:text-[#1D4ED8]" :class="{'nav-active': currentTab === 'members'}"><i class="fa-solid fa-users text-xl"></i><span class="text-xs font-medium">æˆå“¡</span></button>
    </nav>

    <!-- MODALS -->
    <!-- Event Modal -->
    <div v-if="showModal" class="fixed inset-0 bg-black/70 z-[100] flex items-center justify-center px-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl animate-fade-in-up border border-gray-200">
            <h3 class="font-bold text-lg mb-4 text-gray-800">{{ isEditing ? 'ç·¨è¼¯è¡Œç¨‹' : 'æ–°å¢è¡Œç¨‹' }}</h3>
            <div class="space-y-3">
                <input v-model="modalEvent.title" type="text" placeholder="åœ°é» / æ´»å‹•åç¨±" class="w-full bg-gray-100 text-gray-800 p-3 rounded-xl outline-none focus:ring-2 focus:ring-blue-400 border border-gray-200">
                <div class="flex gap-2">
                    <input v-model="modalEvent.time" type="time" class="bg-gray-100 text-gray-800 p-3 rounded-xl outline-none border border-gray-200">
                    <select v-model="modalEvent.type" class="flex-1 bg-gray-100 text-gray-800 p-3 rounded-xl outline-none border border-gray-200"><option value="sight">æ™¯é»</option><option value="food">ç¾é£Ÿ</option><option value="transport">äº¤é€š</option><option value="hotel">ä½å®¿</option></select>
                </div>
                 <div class="flex gap-2"><input v-model="modalEvent.location" type="text" placeholder="åœ°é» (é¸å¡«)" class="flex-1 bg-gray-100 text-gray-800 p-3 rounded-xl outline-none text-sm border border-gray-200"><input v-model.number="modalEvent.cost" type="number" placeholder="é ç®—" class="w-24 bg-gray-100 text-gray-800 p-3 rounded-xl outline-none text-sm border border-gray-200"></div>
                <input v-model="modalEvent.note" type="text" placeholder="å‚™è¨» (é¸å¡«)" class="w-full bg-gray-100 text-gray-800 p-3 rounded-xl outline-none text-sm border border-gray-200">
            </div>
            <div class="flex gap-3 mt-6"><button @click="showModal = false" class="flex-1 py-3 rounded-xl bg-gray-200 text-gray-600 font-bold hover:bg-gray-300 transition-colors">å–æ¶ˆ</button><button @click="saveEvent" class="flex-1 py-3 rounded-xl bg-[#1D4ED8] text-white font-bold shadow-lg hover:bg-blue-700 transition-colors">ä¿å­˜</button></div>
        </div>
    </div>

    <!-- Expense Edit Modal -->
    <div v-if="showExpenseEditModal" class="fixed inset-0 bg-black/70 z-[150] flex items-center justify-center px-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl animate-fade-in-up border border-gray-200">
            <h3 class="font-bold text-lg mb-4 text-gray-800">ç·¨è¼¯æ¶ˆè²»</h3>
            <div class="flex gap-2 mb-3">
                <div class="w-24 h-24 bg-gray-100 rounded-xl flex items-center justify-center relative overflow-hidden group flex-shrink-0 border border-gray-200" @click="$refs.editExpenseFile.click()">
                     <img v-if="editingExpense.image" :src="editingExpense.image" class="w-full h-full object-cover">
                     <div v-else class="text-gray-400"><i class="fa-solid fa-camera text-2xl"></i></div>
                     <div class="absolute inset-0 bg-black/10 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity"><i class="fa-solid fa-pen text-white"></i></div>
                     <button v-if="editingExpense.image" @click.stop="editingExpense.image = null" class="absolute top-1 right-1 bg-black/50 text-white w-5 h-5 rounded-full flex items-center justify-center text-xs"><i class="fa-solid fa-xmark"></i></button>
                </div>
                <input type="file" ref="editExpenseFile" accept="image/*" class="hidden" @change="(e) => handleExpenseImage(e, true)">
                <div class="flex-1 space-y-3">
                    <div><label class="text-[10px] text-gray-500 block mb-1">é‡‘é¡ (KRW)</label><input type="number" inputmode="numeric" pattern="[0-9]*" v-model.number="editingExpense.amount" class="w-full bg-gray-100 text-gray-800 rounded-lg px-3 py-2 font-bold outline-none text-lg border border-gray-200" onkeypress="return event.charCode >= 48 && event.charCode <= 57"></div>
                     <div><label class="text-[10px] text-gray-500 block mb-1">ç´„åˆå°å¹£</label><div class="text-gray-600 text-sm pl-1">NT$ {{ Math.round(editingExpense.amount * exchangeRate) }}</div></div>
                </div>
            </div>
            <div class="space-y-3 mb-6">
                 <input type="text" v-model="editingExpense.title" class="w-full bg-gray-100 text-gray-800 rounded-xl px-3 py-3 outline-none border border-gray-200" placeholder="æ¶ˆè²»é …ç›®">
                 <div class="flex gap-2 overflow-x-auto no-scrollbar pb-1">
                    <button v-for="member in members" :key="member.id || member.name" @click="editingExpense.payer = member.name" class="px-3 py-1.5 rounded-full text-sm border whitespace-nowrap transition-colors flex items-center gap-1" :class="editingExpense.payer === member.name ? 'bg-[#1D4ED8] text-white border-[#1D4ED8]' : 'border-gray-300 text-gray-500'">{{ member.name }}</button>
                </div>
            </div>
            <div class="flex gap-3"><button @click="deleteExpense" class="flex-1 py-3 rounded-xl bg-red-50 text-red-500 font-bold border border-red-100 hover:bg-red-100">åˆªé™¤</button><button @click="saveExpenseChanges" class="flex-[2] py-3 rounded-xl bg-[#1D4ED8] text-white font-bold shadow-lg hover:bg-blue-700">æ›´æ–°</button></div>
            <button @click="showExpenseEditModal = false" class="w-full mt-3 text-gray-400 text-xs hover:text-gray-600">å–æ¶ˆ</button>
        </div>
    </div>

    <!-- Password Modal -->
    <div v-if="showPasswordModal" class="fixed inset-0 bg-black/70 z-[200] flex items-center justify-center px-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-xs rounded-3xl p-6 shadow-2xl animate-fade-in-up text-center border border-gray-200" :class="{'animate-shake': passwordShake}">
            <div class="w-12 h-12 bg-gray-100 text-[#1D4ED8] rounded-full flex items-center justify-center mx-auto mb-3 border border-gray-200"><i class="fa-solid fa-lock"></i></div>
            <h3 class="font-bold text-lg text-gray-800 mb-1">æ¬Šé™é©—è­‰</h3>
            <p class="text-xs text-gray-500 mb-4">{{ passwordPromptText }}</p>
            <input type="password" v-model="passwordInput" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" class="w-full text-center bg-gray-100 text-gray-800 border border-gray-300 p-3 rounded-xl outline-none focus:ring-2 focus:ring-[#1D4ED8] text-lg tracking-widest mb-4">
            <div class="flex gap-2"><button @click="showPasswordModal = false" class="flex-1 py-2 text-gray-400 text-sm hover:text-gray-600">å–æ¶ˆ</button><button @click="checkPassword" class="flex-1 py-2 bg-[#1D4ED8] text-white rounded-xl font-bold text-sm shadow-lg hover:bg-blue-700">ç¢ºèª</button></div>
        </div>
    </div>

    <!-- Flight Edit Modal -->
    <div v-if="showFlightEditModal" class="fixed inset-0 bg-black/70 z-[150] flex items-center justify-center px-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl animate-fade-in-up max-h-[90vh] overflow-y-auto no-scrollbar border border-gray-200">
            <h3 class="font-bold text-lg mb-4 text-gray-800">ç·¨è¼¯ç­æ©Ÿè³‡è¨Š</h3>
            <div class="space-y-4">
                <div class="bg-gray-50 p-3 rounded-xl space-y-3 border border-gray-100">
                    <p class="text-xs font-bold text-gray-500">èˆªç­æ™‚é–“</p>
                    <div class="flex gap-2"><div class="flex-1"><label class="text-[10px] text-gray-400 uppercase font-bold ml-1">å‡ºç™¼</label><input v-model="editingFlight.depTime" type="time" class="w-full bg-white text-gray-800 border border-gray-300 p-2 rounded-lg outline-none font-bold"></div><div class="flex-1"><label class="text-[10px] text-gray-400 uppercase font-bold ml-1">æŠµé”</label><input v-model="editingFlight.arrTime" type="time" class="w-full bg-white text-gray-800 border border-gray-300 p-2 rounded-lg outline-none font-bold"></div></div>
                    <div><label class="text-[10px] text-gray-400 uppercase font-bold ml-1">æ—¥æœŸ</label><input v-model="editingFlight.date" type="text" class="w-full bg-white text-gray-800 border border-gray-300 p-2 rounded-lg outline-none"></div>
                </div>
                <div class="grid grid-cols-2 gap-3"><div><label class="text-[10px] text-gray-400 uppercase font-bold ml-1">èˆªç­ä»£è™Ÿ</label><input v-model="editingFlight.code" type="text" class="w-full bg-gray-100 text-gray-800 p-2 rounded-lg outline-none border border-gray-200"></div><div><label class="text-[10px] text-stone-400 uppercase font-bold ml-1">æ©Ÿå‹</label><input v-model="editingFlight.aircraft" type="text" class="w-full bg-gray-100 text-gray-800 p-2 rounded-lg outline-none border border-gray-200"></div></div>
                <div class="border-t border-gray-200 pt-2 space-y-3">
                    <p class="text-xs font-bold text-gray-500">è³¼ç¥¨è©³æƒ…</p>
                    <div class="grid grid-cols-2 gap-3"><div><label class="text-[10px] text-stone-400 ml-1">é‡‘é¡</label><input v-model="editingFlight.price" type="text" class="w-full bg-gray-100 text-gray-800 p-2 rounded-lg outline-none border border-gray-200"></div><div><label class="text-[10px] text-stone-400 ml-1">è³¼è²·æ—¥æœŸ</label><input v-model="editingFlight.purchaseDate" type="text" class="w-full bg-gray-100 text-gray-800 p-2 rounded-lg outline-none border border-gray-200"></div></div>
                    <div><label class="text-[10px] text-stone-400 ml-1">è³¼è²·å¹³å°</label><input v-model="editingFlight.platform" type="text" class="w-full bg-gray-100 text-gray-800 p-2 rounded-lg outline-none border border-gray-200"></div>
                    <div class="grid grid-cols-2 gap-3"><div><label class="text-[10px] text-stone-400 ml-1">è³¼è²·å½¢å¼</label><input v-model="editingFlight.type" type="text" class="w-full bg-gray-100 text-gray-800 p-2 rounded-lg outline-none border border-gray-200"></div><div><label class="text-[10px] text-stone-400 ml-1">è¡Œæå…¬æ–¤æ•¸</label><input v-model="editingFlight.baggage" type="text" class="w-full bg-gray-100 text-gray-800 p-2 rounded-lg outline-none border border-gray-200"></div></div>
                    <div><label class="text-[10px] text-stone-400 ml-1">å‚™è¨»</label><input v-model="editingFlight.note" type="text" placeholder="ä¾‹å¦‚ï¼šåŠ è³¼è¡Œæ..." class="w-full bg-gray-100 text-gray-800 p-2 rounded-lg outline-none border border-gray-200"></div>
                </div>
            </div>
            <div class="flex gap-3 mt-6"><button @click="showFlightEditModal = false" class="flex-1 py-3 rounded-xl bg-gray-200 text-gray-600 font-bold hover:bg-gray-300">å–æ¶ˆ</button><button @click="saveFlightChanges" class="flex-1 py-3 rounded-xl bg-[#1D4ED8] text-white font-bold shadow-lg hover:bg-blue-700">æ›´æ–°</button></div>
        </div>
    </div>

    <!-- Car Edit Modal -->
    <div v-if="showCarEditModal" class="fixed inset-0 bg-black/70 z-[150] flex items-center justify-center px-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl animate-fade-in-up max-h-[90vh] overflow-y-auto no-scrollbar border border-gray-200">
            <h3 class="font-bold text-lg mb-4 text-gray-800">ç·¨è¼¯ç§Ÿè»Šè³‡è¨Š</h3>
            <div class="space-y-4">
                <div class="bg-gray-50 p-3 rounded-xl space-y-3 border border-gray-100">
                    <p class="text-xs font-bold text-gray-500">ç§Ÿè»Šè³‡è¨Š</p>
                    <div><label class="text-[10px] text-gray-400 block mb-1">ç§Ÿè»Šå…¬å¸</label><input v-model="editingCar.company" type="text" class="w-full bg-white border border-gray-300 p-2 rounded-lg outline-none"></div>
                    <div><label class="text-[10px] text-gray-400 block mb-1">è»Šå‹</label><input v-model="editingCar.carModel" type="text" class="w-full bg-white border border-gray-300 p-2 rounded-lg outline-none font-bold text-lg"></div>
                </div>
                <div class="border-t border-gray-200 pt-2 space-y-3">
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="text-[10px] text-gray-400 block mb-1">å–è»Šæ—¥æœŸ</label><input v-model="editingCar.pickupDate" type="text" placeholder="ä¾‹å¦‚: 03/16 10:00" class="w-full bg-gray-100 text-gray-800 p-2 rounded-lg outline-none text-sm border border-gray-200"></div>
                        <div><label class="text-[10px] text-gray-400 block mb-1">é‚„è»Šæ—¥æœŸ</label><input v-model="editingCar.returnDate" type="text" placeholder="ä¾‹å¦‚: 03/20 10:00" class="w-full bg-gray-100 text-gray-800 p-2 rounded-lg outline-none text-sm border border-gray-200"></div>
                    </div>
                     <div class="grid grid-cols-2 gap-3">
                        <div><label class="text-[10px] text-gray-400 block mb-1">å–è»Šåœ°é»</label><input v-model="editingCar.pickupLocation" type="text" class="w-full bg-gray-100 text-gray-800 p-2 rounded-lg outline-none text-sm border border-gray-200"></div>
                        <div><label class="text-[10px] text-gray-400 block mb-1">é‚„è»Šåœ°é»</label><input v-model="editingCar.returnLocation" type="text" class="w-full bg-gray-100 text-gray-800 p-2 rounded-lg outline-none text-sm border border-gray-200"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="text-[10px] text-gray-400 block mb-1">è²»ç”¨</label><input v-model="editingCar.price" type="text" class="w-full bg-gray-100 text-gray-800 p-2 rounded-lg outline-none text-sm border border-gray-200"></div>
                        <div><label class="text-[10px] text-gray-400 block mb-1">è¨‚å–®ç·¨è™Ÿ</label><input v-model="editingCar.ref" type="text" class="w-full bg-gray-100 text-gray-800 p-2 rounded-lg outline-none text-sm border border-gray-200"></div>
                    </div>
                </div>
            </div>
            <div class="flex gap-3 mt-6"><button @click="showCarEditModal = false" class="flex-1 py-3 rounded-xl bg-gray-200 text-gray-600 font-bold hover:bg-gray-300">å–æ¶ˆ</button><button @click="saveCarChanges" class="flex-1 py-3 rounded-xl bg-[#1D4ED8] text-white font-bold shadow-lg hover:bg-blue-700">æ›´æ–°</button></div>
        </div>
    </div>

    <!-- Journal Modal -->
    <div v-if="showJournalModal" class="fixed inset-0 bg-black/70 z-[150] flex items-center justify-center px-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-md rounded-3xl p-6 shadow-2xl animate-fade-in-up max-h-[90vh] overflow-y-auto no-scrollbar border border-gray-200">
            <h3 class="font-bold text-lg mb-4 text-gray-800">{{ isEditingJournal ? 'ç·¨è¼¯æ—¥èªŒ' : 'å¯«æ–°æ—¥èªŒ' }}</h3>
            <div class="space-y-4">
                <div class="flex gap-3">
                    <div class="flex-1">
                        <label class="text-[10px] text-gray-400 block mb-1">æ—¥æœŸ</label>
                        <input v-model="journalForm.date" type="date" class="w-full bg-gray-100 text-gray-800 rounded-xl px-3 py-2 text-sm outline-none border border-gray-200">
                    </div>
                    <div class="flex-1">
                        <label class="text-[10px] text-gray-400 block mb-1">è¨˜éŒ„äºº</label>
                        <select v-model="journalForm.author" class="w-full bg-gray-100 text-gray-800 rounded-xl px-3 py-2 text-sm outline-none border border-gray-200">
                            <option v-for="m in members" :key="m.id || m.name" :value="m.name">{{ m.name }}</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="text-[10px] text-gray-400 block mb-1">å…§å®¹</label>
                    <textarea v-model="journalForm.content" class="w-full bg-gray-100 text-gray-800 rounded-xl p-3 text-sm outline-none h-32 resize-none border border-gray-200" placeholder="å¯«ä¸‹ä»Šå¤©ç™¼ç”Ÿçš„è¶£äº‹..."></textarea>
                </div>
                <div>
                    <label class="text-[10px] text-gray-400 block mb-2">ç…§ç‰‡ (æœ€å¤š5å¼µ)</label>
                    <div class="flex gap-2 overflow-x-auto pb-2">
                        <div v-if="journalForm.photos.length < 5" @click="$refs.journalPhotosInput.click()" class="w-20 h-20 bg-gray-100 rounded-xl flex items-center justify-center cursor-pointer hover:bg-gray-200 flex-shrink-0 border border-dashed border-gray-400">
                            <i class="fa-solid fa-plus text-gray-400"></i>
                        </div>
                        <div v-for="(photo, idx) in journalForm.photos" :key="idx" class="w-20 h-20 rounded-xl overflow-hidden relative flex-shrink-0 group">
                            <img :src="photo" class="w-full h-full object-cover">
                            <button @click="removeJournalPhoto(idx)" class="absolute top-1 right-1 bg-black/50 text-white w-5 h-5 rounded-full flex items-center justify-center text-xs"><i class="fa-solid fa-xmark"></i></button>
                        </div>
                    </div>
                    <input type="file" ref="journalPhotosInput" multiple accept="image/*" class="hidden" @change="handleJournalImages">
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button @click="showJournalModal = false" class="flex-1 py-3 rounded-xl bg-gray-200 text-gray-600 font-bold hover:bg-gray-300">å–æ¶ˆ</button>
                <button @click="saveJournal" class="flex-1 py-3 rounded-xl bg-[#1D4ED8] text-white font-bold shadow-lg hover:bg-blue-700">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- Member Modal -->
    <div v-if="showMemberModal" class="fixed inset-0 bg-black/70 z-[100] flex items-center justify-center px-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl animate-fade-in-up border border-gray-200">
            <h3 class="font-bold text-lg mb-4 text-gray-800">{{ isNewMember ? 'æ–°å¢æˆå“¡' : 'ç·¨è¼¯æˆå“¡' }}</h3>
            <div class="flex flex-col items-center mb-6">
                <div class="relative w-24 h-24 rounded-full bg-gray-100 mb-3 border-2 border-gray-200 overflow-hidden cursor-pointer group" @click="$refs.memberAvatarInput.click()">
                    <img v-if="editingMember.avatar" :src="editingMember.avatar" class="w-full h-full object-cover">
                    <div v-else class="w-full h-full flex items-center justify-center text-gray-400"><i class="fa-solid fa-user text-3xl"></i></div>
                    <div class="absolute inset-0 bg-black/30 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity"><i class="fa-solid fa-camera text-white"></i></div>
                </div>
                <input type="file" ref="memberAvatarInput" class="hidden" accept="image/*" @change="handleMemberAvatar">
                <p class="text-[10px] text-gray-400">é»æ“Šä¸Šå‚³ç…§ç‰‡</p>
            </div>
            <div class="space-y-3"><div><label class="text-xs text-gray-400 font-bold ml-1">åç¨± (é™3å­—)</label><input v-model="editingMember.name" type="text" maxlength="3" placeholder="ä¾‹å¦‚ï¼šå°æ˜" class="w-full bg-gray-100 text-gray-800 p-3 rounded-xl outline-none focus:ring-2 focus:ring-blue-400 text-center font-bold text-lg border border-gray-200"></div></div>
            <div class="flex gap-3 mt-6"><button @click="showMemberModal = false" class="flex-1 py-3 rounded-xl bg-gray-200 text-gray-600 font-bold hover:bg-gray-300">å–æ¶ˆ</button><button @click="saveMember" class="flex-1 py-3 rounded-xl bg-[#1D4ED8] text-white font-bold shadow-lg hover:bg-blue-700">ä¿å­˜</button></div>
        </div>
    </div>

    <!-- Image Modal -->
    <div v-if="showImageModal" class="fixed inset-0 bg-black/90 z-[110] flex items-center justify-center p-4 backdrop-blur-sm" @click="showImageModal = false">
        <img :src="currentImage" class="max-w-full max-h-[85vh] rounded-lg shadow-2xl" @click.stop>
        <button class="absolute top-4 right-4 text-white text-2xl p-2 hover:text-gray-300"><i class="fa-solid fa-xmark"></i></button>
    </div>

</div>

<script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
    import { getFirestore, doc, onSnapshot, setDoc, collection } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';
    import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
    
    const { createApp, ref, computed, onMounted, watch } = Vue;

    createApp({
        setup() {
            // --- Helper: Image Compressor ---
            const compressImage = (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = (event) => {
                        const img = new Image();
                        img.src = event.target.result;
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const MAX_WIDTH = 800; // Limit width
                            const scaleSize = MAX_WIDTH / img.width;
                            canvas.width = MAX_WIDTH;
                            canvas.height = img.height * scaleSize;
                            
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                            
                            // Compress to JPEG with 0.7 quality
                            const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                            resolve(dataUrl);
                        };
                        img.onerror = (err) => reject(err);
                    };
                    reader.onerror = (err) => reject(err);
                });
            };

            // --- State Initialization ---
            const currentTab = ref('schedule');
            const bookingSubTab = ref('flight');
            const isLoading = ref(true);
            const expenseFilter = ref('all'); 
            const isOnlineMode = ref(false);
            const showInstallPrompt = ref(false); 
            
            // Data Refs
            const members = ref([]);
            const expenses = ref([]);
            const lists = ref({ todo: [], packing: [], wish: [] });
            const journals = ref([]); 
            
            const defaultFlights = [
                { airline: 'é‡œå±±èˆªç©º', code: 'BX 796', date: '2026/03/10', origin: 'KHH', originCity: 'é«˜é›„', dest: 'PUS', destCity: 'é‡œå±±', depTime: '15:00', arrTime: '18:25', duration: '02h25m', aircraft: 'A321', baggage: '15kg', color: 'bg-blue-500', purchaseDate: '2025/11/14', platform: 'å®˜ç¶²', price: 'NT$4,633', type: 'åŒä¸€å¼µè¨‚å–®', note: '' },
                { airline: 'çœŸèˆªç©º', code: 'LJ 579', date: '2026/03/16', origin: 'PUS', originCity: 'é‡œå±±', dest: 'CJU', destCity: 'æ¿Ÿå·', depTime: '13:20', arrTime: '14:20', duration: '1h', aircraft: 'B737-800', baggage: '15kg', color: 'bg-green-500', purchaseDate: '2025/11/15', platform: 'å®˜ç¶²', price: 'NT$1,037', type: 'åŒä¸€å¼µè¨‚å–®', note: 'å°¼æ­æœ‰å¤šåŠ 5kg/240å…ƒ' },
                { airline: 'å¾·å¨èˆªç©º', code: 'TW 689', date: '2026/03/24', origin: 'CJU', originCity: 'æ¿Ÿå·', dest: 'KHH', destCity: 'é«˜é›„', depTime: '11:05', arrTime: '12:40', duration: '02h35m', aircraft: 'B737-800', baggage: '15kg', color: 'bg-red-500', purchaseDate: '2025/11/15', platform: 'ly.com / Hopegoo', price: 'NT$3,488', type: 'æ‹†ä¸‰å¼µè¨‚å–®', note: '' }
            ];
            const flightData = ref(defaultFlights);
            const itineraryData = ref({});
            const accommodations = ref([{ city: 'é‡œå±±', name: 'Avani Central Busan', address: '133 Jeonpo-daero, Nam-gu', checkIn: '15:00', ref: 'B-123456' }, { city: 'æ¿Ÿå·', name: 'Grand Hyatt Jeju', address: '12 Noyeon-ro, Jeju-si', checkIn: '15:00', ref: 'J-987654' }]);
            const carRental = ref({ company: '', carModel: '', pickupDate: '', pickupLocation: '', returnDate: '', returnLocation: '', price: '', ref: '' });

            // Refs
            const showModal = ref(false);
            const isEditing = ref(false);
            const editingId = ref(null);
            const modalEvent = ref({ title: '', time: '09:00', type: 'sight', location: '', cost: '', note: '' });
            const newExpense = ref({ amount: '', title: '', payer: 'æˆ‘', image: null });
            const showImageModal = ref(false);
            const currentImage = ref('');
            const currentList = ref('todo');
            const newItemInput = ref('');
            const newItemAssignee = ref('å…¨é«”');
            const showFlightEditModal = ref(false);
            const editingFlightIndex = ref(-1);
            const editingFlight = ref({});
            const showMemberModal = ref(false);
            const isNewMember = ref(false);
            const editingMember = ref({ id: null, name: '', avatar: null });
            const editingMemberIndex = ref(-1);
            const showExpenseEditModal = ref(false);
            const editingExpenseIndex = ref(-1);
            const editingExpense = ref({});
            const showPasswordModal = ref(false);
            const passwordInput = ref('');
            const passwordShake = ref(false);
            const passwordAction = ref('');
            const passwordPayload = ref(null);
            const showCarEditModal = ref(false);
            const editingCar = ref({});
            const showJournalModal = ref(false);
            const isEditingJournal = ref(false);
            const editingJournalIndex = ref(-1);
            const journalForm = ref({ id: null, date: '', author: '', content: '', photos: [] });

            // --- Firebase Logic ---
            let auth = null;
            let db = null;
            let appId = 'default-app-id';
            
            // â˜…â˜…â˜… æ‚¨çš„é‡‘é‘° â˜…â˜…â˜…
            const firebaseConfig = {
                apiKey: "AIzaSyAbBa7qI8_HXXGYWWo37LeBkSjrA-Bi3Gw",
                authDomain: "koreatrip2026-c034b.firebaseapp.com",
                projectId: "koreatrip2026-c034b",
                storageBucket: "koreatrip2026-c034b.firebasestorage.app",
                messagingSenderId: "635203744876",
                appId: "1:635203744876:web:493e4c88e37b843d6c9449",
                measurementId: "G-LRQ0R7CHFQ"
            };

            const initFirebase = () => {
                try {
                    if (Object.keys(firebaseConfig).length > 0) {
                        const app = initializeApp(firebaseConfig);
                        auth = getAuth(app);
                        db = getFirestore(app);
                        if (typeof __app_id !== 'undefined') appId = __app_id;
                        
                        isOnlineMode.value = true;
                        return true;
                    }
                } catch (e) { console.warn("Firebase init failed (Offline Mode):", e); }
                isOnlineMode.value = false;
                return false;
            };

            const saveData = async (collectionName, data) => {
                if (isOnlineMode.value && auth && auth.currentUser) {
                    try {
                        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'korea_trip_2026', collectionName), { data: JSON.stringify(data) });
                    } catch (e) { console.error("Cloud Save failed", e); alert("é›²ç«¯å„²å­˜å¤±æ•—"); }
                } else {
                    try { localStorage.setItem(`korea_${collectionName}_v3`, JSON.stringify(data)); } catch(e) { alert("æœ¬æ©Ÿå„²å­˜ç©ºé–“ä¸è¶³"); }
                }
            };
            
            const isDataEmpty = (val) => val === undefined || (Array.isArray(val) && val.length === 0) || (typeof val === 'object' && Object.keys(val).length === 0);

            const loadData = (collectionName, refVar, defaultVal) => {
                if (isOnlineMode.value) {
                    onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'korea_trip_2026', collectionName), (docSnap) => {
                        if (docSnap.exists()) {
                            try { refVar.value = JSON.parse(docSnap.data().data); } catch (e) { refVar.value = defaultVal; }
                        } else {
                            if (isDataEmpty(refVar.value)) { refVar.value = defaultVal; saveData(collectionName, defaultVal); }
                        }
                    });
                } else {
                    try {
                        const local = localStorage.getItem(`korea_${collectionName}_v3`);
                        if (local) refVar.value = JSON.parse(local); else { refVar.value = defaultVal; saveData(collectionName, defaultVal); }
                    } catch(e) { refVar.value = defaultVal; }
                }
            };

            const initAuth = async () => {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    try {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } catch (e) {
                        await signInAnonymously(auth);
                    }
                } else {
                    try {
                        await signInAnonymously(auth);
                    } catch (e) {
                        console.error("Anonymous Sign-in Failed. Switching to OFFLINE mode.", e);
                        isOnlineMode.value = false;
                    }
                }
            };
            
            const startSync = () => {
                loadData('members', members, [{ id: 1, name: 'æˆ‘', avatar: null }]);
                loadData('expenses', expenses, []);
                loadData('lists', lists, { todo: [], packing: [], wish: [] });
                loadData('flights', flightData, defaultFlights);
                loadData('itinerary', itineraryData, {
                    '2026-03-10': [{ id: 1, time: '13:00', title: 'å°æ¸¯æ©Ÿå ´å ±åˆ°', type: 'transport', location: 'KHH', lat: 22.57, lng: 120.35, note: 'è¨˜å¾—æ‹¿è­·ç…§' }, { id: 2, time: '18:25', title: 'æŠµé”é‡œå±±', type: 'transport', location: 'PUS', lat: 35.17, lng: 128.94, note: 'å‡ºé—œå¾Œå»æ›éŒ¢' }],
                    '2026-03-16': [{ id: 3, time: '13:20', title: 'é£›å¾€æ¿Ÿå·å³¶', type: 'transport', location: 'PUS', lat: 35.17, lng: 128.94 }],
                    '2026-03-24': [{ id: 4, time: '11:05', title: 'å›å°ç£å›‰', type: 'transport', location: 'CJU', lat: 33.51, lng: 126.49 }]
                });
                loadData('accommodations', accommodations, [{ city: 'é‡œå±±', name: 'Avani Central Busan', address: '133 Jeonpo-daero, Nam-gu', checkIn: '15:00', ref: 'B-123456' }, { city: 'æ¿Ÿå·', name: 'Grand Hyatt Jeju', address: '12 Noyeon-ro, Jeju-si', checkIn: '15:00', ref: 'J-987654' }]);
                loadData('carRental', carRental, { company: '', carModel: '', pickupDate: '', pickupLocation: '', returnDate: '', returnLocation: '', price: '', ref: '' });
                loadData('journals', journals, []);
                
                setTimeout(() => isLoading.value = false, 800);
            };

            const forceRefreshData = () => {
                isLoading.value = true;
                if (isOnlineMode.value) setTimeout(() => isLoading.value = false, 500); else startSync();
            };

            onMounted(async () => {
                // Check if in standalone mode (PWA)
                const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone || document.referrer.includes('android-app://');
                // Check if mobile
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                
                if (isMobile && !isStandalone) {
                    setTimeout(() => showInstallPrompt.value = true, 2000);
                }

                const online = initFirebase();
                if (online) {
                     await initAuth();
                     onAuthStateChanged(auth, (user) => { if (user) startSync(); });
                } else { startSync(); }
            });

            // Dates & Computed
            const generateDates = () => {
                let curr = new Date(new Date('2026-03-10'));
                const end = new Date('2026-03-24');
                const days = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
                let count = 1; 
                while (curr <= end) {
                    tripDates.value.push({ full: curr.toISOString().split('T')[0], day: curr.getDate(), weekday: days[curr.getDay()], month: curr.getMonth() + 1, dayNum: count });
                    curr.setDate(curr.getDate() + 1);
                    count++;
                }
            };
            const tripDates = ref([]);
            const selectedDate = ref({});
            generateDates();
            selectedDate.value = tripDates.value[0];

            // Group journals by date
            const groupedJournals = computed(() => {
                if (!journals.value || journals.value.length === 0) return {};
                const groups = {};
                // Sort journals by date desc first
                const sorted = [...journals.value].sort((a, b) => new Date(b.date) - new Date(a.date));
                sorted.forEach(j => {
                    if (!groups[j.date]) groups[j.date] = [];
                    groups[j.date].push(j);
                });
                return groups;
            });

            const currentItinerary = computed(() => (itineraryData.value[selectedDate.value.full] || []).sort((a, b) => a.time.localeCompare(b.time)));
            const filteredExpenses = computed(() => expenseFilter.value === 'all' ? expenses.value : expenses.value.filter(e => e.payer === expenseFilter.value));
            const totalExpenseKRW = computed(() => filteredExpenses.value.reduce((s, i) => s + i.amount, 0));
            const exchangeRate = 0.024;
            const totalExpenseTWD = computed(() => Math.round(totalExpenseKRW.value * exchangeRate));
            const getCurrentListItems = computed(() => lists.value[currentList.value] || []);
            const passwordPromptText = computed(() => {
                const map = { 'add_member': 'æ–°å¢æˆå“¡', 'delete_member': 'åˆªé™¤æˆå“¡', 'flight_edit': 'ä¿®æ”¹ç­æ©Ÿ' };
                return (map[passwordAction.value] || 'æ“ä½œ') + 'éœ€è¦ç®¡ç†æ¬Šé™';
            });

            const getMemberAvatar = (name) => {
                if (!name || typeof name !== 'string') return null;
                const m = members.value.find(m => m.name === name);
                return m ? m.avatar : null;
            };
            const formatNumber = (num) => num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            const getCategoryColor = (type) => ({ sight: 'bg-blue-400', food: 'bg-orange-400', transport: 'bg-stone-500', hotel: 'bg-indigo-400' }[type] || 'bg-gray-400');
            const getWeather = (location) => {
                const isJeju = selectedDate.value.full >= '2026-03-16';
                const baseTemp = isJeju ? 16 : 12;
                const randomVar = Math.floor(Math.random() * 5);
                const icons = ['fa-solid fa-sun text-orange-400', 'fa-solid fa-cloud-sun text-yellow-500', 'fa-solid fa-cloud text-gray-400'];
                return { temp: `${baseTemp + randomVar}Â°C`, icon: icons[randomVar % 3] };
            };
            const locateMe = () => { alert("åœ°åœ–åŠŸèƒ½å·²ç§»é™¤"); };
            const selectDate = (date) => { selectedDate.value = date; }; 

            // Trip Status & Countdown Logic
            const today = new Date();
            today.setHours(0,0,0,0);
            const tripStart = new Date('2026-03-10');
            const tripEnd = new Date('2026-03-24');
            const purchaseDate = new Date('2025-11-14'); 

            const tripStatus = computed(() => {
                if (today < tripStart) return 'before';
                if (today >= tripStart && today <= tripEnd) return 'during';
                return 'after';
            });

            const countdownDays = computed(() => {
                 const diffTime = tripStart - today;
                 return Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
            });

            const countdownProgress = computed(() => {
                const total = tripStart - purchaseDate;
                const current = today - purchaseDate;
                
                if (current < 0) return 0;
                if (current > total) return 100;
                return (current / total) * 100;
            });

            const currentDayNum = computed(() => {
                const diffTime = Math.abs(today - tripStart);
                return Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
            });

            const tripProgress = computed(() => {
                 const total = tripEnd - tripStart;
                 const current = today - tripStart;
                 return (current / total) * 100;
            });

            // --- CRUD Actions (Fixed) ---
            const openModal = () => { 
                isEditing.value = false; 
                modalEvent.value = { title: '', time: '09:00', type: 'sight', location: '', cost: '', note: '' }; 
                showModal.value = true; 
            };
            const editEvent = (item) => { 
                isEditing.value = true; 
                editingId.value = item.id; 
                modalEvent.value = JSON.parse(JSON.stringify(item)); // Deep copy
                showModal.value = true; 
            };
            const saveEvent = () => {
                if (!modalEvent.value.title) return;
                const dateKey = selectedDate.value.full;
                if (!itineraryData.value[dateKey]) itineraryData.value[dateKey] = [];
                
                if (isEditing.value) {
                    const index = itineraryData.value[dateKey].findIndex(e => e.id === editingId.value);
                    if (index !== -1) {
                        itineraryData.value[dateKey][index] = { ...modalEvent.value }; // Replace
                    }
                } else {
                    itineraryData.value[dateKey].push({ id: Date.now(), ...modalEvent.value });
                }
                saveData('itinerary', itineraryData.value);
                showModal.value = false;
            };
            const deleteEvent = (index) => {
                if(confirm("ç¢ºå®šåˆªé™¤æ­¤è¡Œç¨‹ï¼Ÿ")) {
                    const dateKey = selectedDate.value.full;
                    itineraryData.value[dateKey].splice(index, 1);
                    saveData('itinerary', itineraryData.value);
                }
            };

            const handleExpenseImage = async (e, isEdit = false) => { 
                const f = e.target.files[0]; if(f) { try { const url = await compressImage(f); if (isEdit) editingExpense.value.image = url; else newExpense.value.image = url; } catch (err) { alert("åœ–ç‰‡è™•ç†å¤±æ•—"); } }
            };
            const viewImage = (src) => { currentImage.value = src; showImageModal.value = true; };
            const addExpense = () => {
                if (!newExpense.value.amount || !newExpense.value.title) return;
                const exp = { ...newExpense.value, date: new Date().toLocaleDateString(), id: Date.now() };
                expenses.value.unshift(exp); 
                saveData('expenses', expenses.value); 
                newExpense.value = { amount: '', title: '', payer: newExpense.value.payer, image: null };
            };
            
            // Fixed Edit Expense
            const initEditExpense = (expense) => { 
                // Find index in the original array by ID (safest)
                const idx = expenses.value.findIndex(e => e.id === expense.id); 
                if (idx !== -1) { 
                    editingExpenseIndex.value = idx; 
                    editingExpense.value = JSON.parse(JSON.stringify(expenses.value[idx])); 
                    showExpenseEditModal.value = true; 
                } 
            };
            const saveExpenseChanges = () => { 
                if (editingExpenseIndex.value !== -1) { 
                    expenses.value[editingExpenseIndex.value] = { ...editingExpense.value }; 
                    saveData('expenses', expenses.value); 
                    showExpenseEditModal.value = false; 
                } 
            };
            const deleteExpense = () => { 
                if(confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†æ¶ˆè²»å—ï¼Ÿ")) { // Added alert
                    if (editingExpenseIndex.value !== -1) { 
                        expenses.value.splice(editingExpenseIndex.value, 1); 
                        saveData('expenses', expenses.value); 
                        showExpenseEditModal.value = false; 
                    }
                }
            };

            const addListItem = () => { if(!newItemInput.value) return; lists.value[currentList.value].push({ text: newItemInput.value, done: false, assignee: newItemAssignee.value }); newItemInput.value = ''; saveData('lists', lists.value); };
            const toggleListItem = (idx) => { const item = lists.value[currentList.value][idx]; item.done = !item.done; saveData('lists', lists.value); };
            const deleteListItem = (idx) => { lists.value[currentList.value].splice(idx, 1); saveData('lists', lists.value); };

            // Accommodations Logic (Fixed)
            const addNewAccommodation = () => { 
                const n = prompt("é£¯åº—åç¨±:"); 
                if(n) { 
                    accommodations.value.push({ city: 'æ–°ä½å®¿', name: n, address: 'åœ°å€å¾…è£œ', checkIn: '15:00', ref: '-' }); 
                    saveData('accommodations', accommodations.value); 
                }
            };
            const editAccommodation = (idx) => { 
                const h = accommodations.value[idx]; 
                const n = prompt("ç·¨è¼¯é£¯åº—åç¨±:", h.name); 
                if(n) { 
                    h.name = n; 
                    h.ref = prompt("è¨‚å–®ç·¨è™Ÿ:", h.ref)||h.ref; 
                    h.city = prompt("åŸå¸‚:", h.city)||h.city;
                    h.checkIn = prompt("Check-in æ™‚é–“:", h.checkIn)||h.checkIn;
                    saveData('accommodations', accommodations.value); 
                }
            };
            const deleteAccommodation = (idx) => { 
                if(confirm("ç¢ºå®šåˆªé™¤æ­¤ä½å®¿ï¼Ÿ")) { 
                    accommodations.value.splice(idx, 1); 
                    saveData('accommodations', accommodations.value); 
                }
            };

            // Car Rental Logic
            const initAddCar = () => {
                editingCarIndex.value = -1; // New
                editingCar.value = { company: '', carModel: '', pickupDate: '', pickupLocation: '', returnDate: '', returnLocation: '', price: '', ref: '' };
                showCarEditModal.value = true;
            };
            // Check if editing existing single object or adding to list? 
            // Assuming single object based on previous req, but let's support basic object update
            const editCar = () => { 
                // For single car rental object structure
                editingCar.value = JSON.parse(JSON.stringify(carRental.value));
                showCarEditModal.value = true; 
            };
            const saveCarChanges = () => { 
                carRental.value = { ...editingCar.value }; 
                saveData('carRental', carRental.value); 
                showCarEditModal.value = false; 
            };
            
            // Flight Edit
            const initEditFlight = (index) => {
                passwordAction.value = 'flight_edit';
                passwordPayload.value = index;
                passwordInput.value = '';
                showPasswordModal.value = true;
            };

            const performProtectedAction = () => {
                if (passwordAction.value === 'flight_edit') { 
                    editingFlightIndex.value = passwordPayload.value; 
                    // Deep copy to prevent direct mutation
                    editingFlight.value = JSON.parse(JSON.stringify(flightData.value[passwordPayload.value])); 
                    showFlightEditModal.value = true; 
                }
                else if (passwordAction.value === 'add_member') { 
                    isNewMember.value = true; 
                    editingMember.value = { id: Date.now(), name: '', avatar: null }; 
                    showMemberModal.value = true; 
                }
                else if (passwordAction.value === 'delete_member') { 
                    // Delete member directly after password check
                    const idx = passwordPayload.value;
                    if (idx > -1 && idx < members.value.length) {
                        members.value.splice(idx, 1); 
                        saveData('members', members.value); 
                    }
                }
            };
            const checkPassword = () => { if (passwordInput.value === '007') { showPasswordModal.value = false; performProtectedAction(); } else { passwordShake.value = true; setTimeout(() => passwordShake.value = false, 500); passwordInput.value = ''; } };
            
            const saveFlightChanges = () => { 
                if (editingFlightIndex.value !== -1) { 
                    flightData.value[editingFlightIndex.value] = { ...editingFlight.value }; 
                    saveData('flights', flightData.value); 
                    showFlightEditModal.value = false; 
                } 
            };
            
            // Member Actions (Fixed)
            const initAddMember = () => { passwordAction.value = 'add_member'; passwordInput.value = ''; showPasswordModal.value = true; };
            const initDeleteMember = (index) => { passwordAction.value = 'delete_member'; passwordPayload.value = index; passwordInput.value = ''; showPasswordModal.value = true; };
            const editMember = (member, index) => { 
                isNewMember.value = false; 
                editingMemberIndex.value = index; 
                editingMember.value = JSON.parse(JSON.stringify(member)); 
                showMemberModal.value = true; 
            };
            const handleMemberAvatar = async (e) => { const f = e.target.files[0]; if(f) { try { const url = await compressImage(f); editingMember.value.avatar = url; } catch (err) { alert("åœ–ç‰‡è™•ç†å¤±æ•—"); } } };
            const saveMember = () => {
                if (!editingMember.value.name) return;
                
                if (isNewMember.value) { 
                    if (members.value.some(m => m.name === editingMember.value.name)) { alert("æˆå“¡åç¨±é‡è¤‡"); return; } 
                    members.value.push({ ...editingMember.value }); 
                } else {
                    const oldName = members.value[editingMemberIndex.value].name; 
                    const newName = editingMember.value.name; 
                    
                    // Update member
                    members.value[editingMemberIndex.value] = { ...editingMember.value };
                    
                    // Update related data if name changed
                    if (oldName !== newName) { 
                        expenses.value.forEach(exp => { if (exp.payer === oldName) exp.payer = newName; }); 
                        saveData('expenses', expenses.value); 
                        Object.keys(lists.value).forEach(k => lists.value[k].forEach(i => { if (i.assignee === oldName) i.assignee = newName; })); 
                        saveData('lists', lists.value); 
                    }
                }
                saveData('members', members.value); 
                showMemberModal.value = false;
            };

            const initAddJournal = () => { isEditingJournal.value = false; const todayStr = new Date().toISOString().split('T')[0]; journalForm.value = { id: Date.now(), date: todayStr, author: members.value[0]?.name || '', content: '', photos: [] }; showJournalModal.value = true; };
            const editJournal = (journal) => { 
                isEditingJournal.value = true; 
                // Find index in original array
                editingJournalIndex.value = journals.value.findIndex(j => j.id === journal.id);
                journalForm.value = JSON.parse(JSON.stringify(journal)); 
                showJournalModal.value = true; 
            };
            const handleJournalImages = async (e) => { const files = e.target.files; if (!files.length) return; if (journalForm.value.photos.length + files.length > 5) { alert("æœ€å¤šåªèƒ½æ”¾ 5 å¼µç…§ç‰‡å–”ï¼"); return; } for (let i = 0; i < files.length; i++) { try { const url = await compressImage(files[i]); journalForm.value.photos.push(url); } catch (err) { console.error(err); } } };
            const removeJournalPhoto = (idx) => { journalForm.value.photos.splice(idx, 1); };
            const saveJournal = () => { 
                if (!journalForm.value.content && journalForm.value.photos.length === 0) return; 
                if (isEditingJournal.value) { 
                    if(editingJournalIndex.value !== -1) journals.value[editingJournalIndex.value] = { ...journalForm.value }; 
                } else { 
                    journals.value.unshift({ ...journalForm.value }); 
                } 
                saveData('journals', journals.value); 
                showJournalModal.value = false; 
            };
            const deleteJournal = (journal) => { 
                if (confirm("ç¢ºå®šåˆªé™¤é€™ç¯‡æ—¥èªŒï¼Ÿ")) { 
                    const idx = journals.value.findIndex(j => j.id === journal.id);
                    if(idx !== -1) {
                        journals.value.splice(idx, 1); 
                        saveData('journals', journals.value); 
                    }
                } 
            };

            watch(currentTab, () => { if(!isOnlineMode.value) forceRefreshData(); });

            return {
                currentTab, tripDates, selectedDate, selectDate, currentItinerary,
                showModal, isEditing, modalEvent, openModal, editEvent, saveEvent, deleteEvent,
                getCategoryColor, getWeather, expenses, members, exchangeRate, newExpense, addExpense, totalExpenseKRW, totalExpenseTWD,
                flightData, formatNumber, locateMe,
                accommodations, addNewAccommodation, editAccommodation, deleteAccommodation,
                currentList, getCurrentListItems, addListItem, toggleListItem, deleteListItem, newItemInput, newItemAssignee,
                handleExpenseImage, viewImage, showImageModal, currentImage,
                initEditFlight, showPasswordModal, passwordInput, checkPassword, passwordShake, showFlightEditModal, editingFlight, saveFlightChanges,
                initAddMember, editMember, showMemberModal, isNewMember, editingMember, handleMemberAvatar, saveMember, initDeleteMember, getMemberAvatar, passwordPromptText,
                showExpenseEditModal, editingExpense, initEditExpense, saveExpenseChanges, deleteExpense,
                isLoading, isOnlineMode, forceRefreshData,
                expenseFilter, filteredExpenses,
                bookingSubTab, carRental, editCar, saveCarChanges, editingCar, showCarEditModal, initAddCar,
                tripStatus, countdownDays, countdownProgress, currentDayNum, tripProgress,
                // Journal
                journals, showJournalModal, isEditingJournal, journalForm, initAddJournal, editJournal, handleJournalImages, removeJournalPhoto, saveJournal, deleteJournal,
                // Journal Groups
                groupedJournals,
                // PWA Prompt
                showInstallPrompt
            };
        }
    }).mount('#app');
</script>

</body>
</html>
